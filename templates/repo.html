{% extends "base.html" %}

{% block branch %}
    <i class='icon-code-fork'></i>
    <select data-repo="{{ repo.id }}" class='branch' value="{{ branch.id }}">
        {% for b in repo.branch_set.all %}
            {% if b.analyzed %}
                {% if b.id == branch.id %}
                    <option value='{{ b.id }}' selected='selected'>{{ b.name }}</option>
                {% else %}
                    <option value='{{ b.id }}'>{{ b.name }}</option>
                {% endif %}
            {% endif %}
        {% endfor %}
    </select>
{% endblock %}

{% block content %}
    <ul class='nav nav-pills'>
        <li class='active'>
            <a href='#' data-target='overview'>Overview</a>
        </li>
        <li>
            <a href='#' data-target='contrib'>Contributors</a>
        </li>
    </ul>

    <hr />

    <table class="table">
        <thead>
            <tr>
                <th colspan='3'>Repository</th>
                <th colspan='4' class='split'>Branch</th>
            </tr>
            <tr>
                <th>Location</th>
                <th>Branches</th>
                <th>Authors</th>
                <th class='split'>Name</th>
                <th>Last analyzed</th>
                <th>Age</th>
                <th>Authors</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>{{ repo.url }}</td>
                <td>{{ repo.branch_count }}</td>
                <td>{{ repo.author_count }}</td>
                <td class='split'>{{ branch.name }}</td>
                <td>{{ branch.analyzed_date }}</td>
                <td>{{ branch.age }}</td>
                <td>{{ branch.author_count }}</td>
            </tr>
        </tbody>
    </table>

    <div class='overview'>
        <div
            class='stats'
            data-repo="{{ repo.href }}"
            data-branch="{{ branch.href }}"></div>

        <hr />

        <div
            class='commits'
            data-repo="{{ repo.href }}"
            data-branch="{{ branch.href }}"></div>
    </div>

    <div class='contrib'>
        <div
            class='contributors'
            data-repo='{{ repo.href }}'
            data-branch="{{ branch.href }}"></div>

        <hr />

        <div
            class='punchcard'
            data-repo='{{ repo.href }}'
            data-branch="{{ branch.href }}"></div>
    </div>
{% endblock %}

{% block specific %}
    <script type="text/javascript">
        $(document).ready(function() {
            $("select.branch").change(function() {
                var branch = $(this).find("option:selected").attr("value");
                var repo = $(this).data("repo");

                window.location.href = "/repo/" + repo + "/branch/" + branch;
            });

            var targets = [];

            $(".nav li").each(function() {
                var li = $(this);

                var changeContent = function(target, targets) {
                    $.each(targets, function() {
                        $(this.toString()).hide();

                        $(".nav li").removeClass("active");
                    });

                    $("." + target)
                        .show();

                    $("*[data-target=" + target + "]").parent("li").addClass("active");
                };

                li.find("a").each(function() {
                    var a = $(this);

                    var target = a.attr("data-target");

                    if(!target) {
                        return;
                    }

                    targets.push("." + target);

                    a.click(function() {
                        changeContent(target, targets);
                        window.location.hash = target;

                        return false;
                    });

                    $("." + target).hide();
                });

                if(window.location.hash) {
                    var target = window.location.hash.replace("#", "");

                    changeContent(target, targets);
                }

                if(li.hasClass("active")) {
                    li.find("a").click();
                }
            });

            var contributors = new analyzr.plugins.Contributors(".contributors");
            contributors.load();
        });
    </script>
{% endblock %}

{% block script %}
    <script type="text/javascript">
        $(document).ready(function() {
            var punchcard = new analyzr.plugins.Punchcard(".punchcard");
            punchcard.load();

            var stats = new analyzr.plugins.FileStatistics(".stats");
            stats.load();

            // var history = new CommitHistory(".commits", {
            //     height: 300,
            //     margins: {
            //         top: 50,
            //         left: 40,
            //         bottom: 20
            //     }
            // });
            // history.load();
        });
    </script>
{% endblock %}
